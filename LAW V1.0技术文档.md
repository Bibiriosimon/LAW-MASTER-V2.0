# LAW MASTER V1.0 — 开发文档（动态骨架 Agent 与多知识库 RAG）

> 适用范围：`E:\LAW MASTER\LAW_MASTER V1.0` 版本
> 
> 目标：详细说明 LAW MASTER V1.0 的构建过程、动态骨架 Agent 设计、Action 体系、工作流编排，以及法条/案例/扩展知识库的构建与检索机制。
> 
> 版本日期：2026-02-12

---

## 1. 项目概述

LAW MASTER V1.0 是一个**法律咨询智能体系统**，包含三层核心能力：

1. **动态骨架 Agent（Dynamic Skeleton Agent）**
   - 以“规划 + 动作执行 + 结果整合”为主线
   - 根据用户问题自动生成不同的流程骨架
   - 每个问题的 workflow 可变，不是固定三步或模板化流程

2. **多知识库检索（法条库 + 案例库 + 可选网页搜索）**
   - 法条库用于法律依据与条文解读
   - 案例库用于类案比对与说服性增强
   - 网页搜索用于补充最新动态或政策类信息

3. **用户交互 UI + 可视化分析**
   - 流式输出
   - 进度条
   - 检索详情折叠
   - 案例预览与 AI 分析
   - 思维导图展示探索过程

---

## 2. 动态骨架 Agent（Dynamic Skeleton Agent）

### 2.1 设计理念

传统 RAG/Agent 往往使用固定的执行流程，而 LAW MASTER 采用“动态骨架”设计：

- **骨架由大模型实时生成**：
  - 每次问题都会由 Reasoner 规划与拆解
  - 生成的问题澄清、检索动作、文书生成等都不是固定顺序

- **骨架的核心是 Action 组合**：
  - 不是简单“问 → 检索 → 答”的线性流程
  - 而是“动作集 + 状态评估 + 再动作”的循环机制

- **允许流程分叉和短路**：
  - 如果无需搜索，流程可跳过检索
  - 如果需要文书，则会进入文书生成分支
  - 如果检索不足，会再次触发搜索或调优关键词

### 2.2 典型 Action 设计

| Action 名称 | 目的 | 输入 | 输出 |
|------------|------|------|------|
| `clarify` | 补充问题要点 | 用户问题 + 历史要点 | 澄清问题列表 |
| `rag_search` | 法条/案例检索 | 关键词 + 向量 | 法条/案例命中 |
| `web_search` | 网页检索 | 关键词 | 网页内容摘要 |
| `answer` | 综合输出 | 多来源上下文 | 完整回答 |
| `generate_document` | 生成法律文书 | 模板 + 事实 + 法条 | PDF 下载 |
| `mindmap` | 结构化展示 | 规划 + 检索 + 结果 | SVG 导图 |

### 2.3 动态骨架示例

- **问题 A（纯法律咨询）**
  - clarify → rag_search → answer → mindmap

- **问题 B（需要政策更新）**
  - clarify → rag_search → web_search → answer → mindmap

- **问题 C（用户直接要文书）**
  - clarify → rag_search → generate_document → answer → mindmap

这种机制确保**每一个问题都是“定制化工作流”**，而不是固定模板。

---

## 3. 主流程执行（Workflow）

### 3.1 普通模式（非自我意识）

1. 用户输入
2. 快速澄清（可跳过）
3. 法条 + 案例检索
4. 输出答案（结构化：结论、法条依据、分析、建议、风险）

### 3.2 自我意识模式（Agent Mode）

1. 用户输入
2. 自动开启网页搜索能力
3. Reasoner 生成动态计划
4. 按计划执行 Action
5. 输出答案 + 思维导图 + 检索详细信息

**特点：**
- 能多轮搜索与优化关键词
- 根据检索质量决定是否继续搜索
- 支持“探索过程”实时更新

---

## 4. 知识库构建

### 4.1 法条库（corpus_enriched_fast.jsonl）

- 格式：JSONL
- 单条结构示例：
```json
{
  "id": 1234,
  "article_number": "民法典 第四百七十九条",
  "source": "中华人民共和国民法典",
  "content": "合同的订立应当遵循自愿、公平、诚实信用原则...",
  "keywords": ["合同", "订立", "自愿"],
  "doc_type": "law"
}
```

### 4.2 案例库（case_kb.jsonl）

- 格式：JSONL
- 单条结构示例：
```json
{
  "id": 205,
  "title": "【案例】二、侵权责任纠纷|181",
  "source": "中国法院2022年度案例",
  "page_start": 181,
  "page_end": 185,
  "summary": "学校未尽管理职责，导致学生伤害事故...",
  "content": "案件事实...裁判要旨...",
  "doc_type": "case"
}
```

### 4.3 扩展知识库（可增量写入）

- 运行时通过网页搜索结果或用户输入补充
- 存储为 JSONL 追加
- 与主库合并检索

---

## 5. 检索系统设计

### 5.1 混合检索

- **关键词匹配**：高精度命中
- **向量相似度（TF-IDF）**：语义召回
- **融合公式**：
```
final_score = keyword_weight * keyword_score + vector_weight * vector_score
```

### 5.2 法条 + 案例双通道

- 法条库与案例库各自检索
- 分别排序后合并为 `retrieval` 展示
- UI 中单独折叠展示（案例/法条分区）

---

## 6. 网页搜索机制

### 6.1 触发策略

- 自我意识模式默认开启
- 普通模式需显式打开开关或 Reasoner 判定

### 6.2 搜索流程

1. Reasoner 生成关键词
2. 通过搜索引擎抓取网页内容
3. 内容摘要与关键词高亮
4. 判断是否足够，若不足则改写关键词再次搜索

---

## 7. 输出生成策略

### 7.1 结构化回答

最终回答固定结构：

1. 结论
2. 法条与案例依据
3. 分析（事实 → 要件）
4. 可行性与诉求评估
5. 分步行动建议
6. 证据清单
7. 风险提示

### 7.2 案例引用

- 输出中自动生成【案例1】【案例2】…
- 前端识别为链接
- 点击可在右侧检索详情定位并高亮案例

---

## 8. 思维导图

### 8.1 生成机制

- 模型基于最终回答生成结构化节点
- 包含：目标分析、检索要点、建议措施
- 支持 SVG 渲染、拖拽、缩放

### 8.2 进度占比

- 进度条最后 10% 专门用于导图生成
- 生成完成后显示“任务完成”状态

---

## 9. 文书生成

### 9.1 触发

- Planner 输出 `action=generate_document`
- 或用户显式点击“专业文书助手”

### 9.2 生成逻辑

- 模板骨架 + 法条/案例依据 + 用户事实
- PDF 输出，附 Logo 与页眉页脚

---

## 10. 前端交互与 UX 设计

### 10.1 进度条

- 普通模式也会自动递增
- 自我意识模式为阶段性推进

### 10.2 红点提示

- 检索完成后“检索详情”右上角显示红点
- 网页搜索有结果则“网页搜索结果”显示红点
- 点击展开后红点消失

---

## 11. 运行与部署

### 11.1 启动命令

```powershell
cd "E:\LAW MASTER\LAW_MASTER V1.0"
python -m uvicorn app_fastapi:app --host 127.0.0.1 --port 7860 --reload
```

### 11.2 依赖安装

```powershell
python -m pip install -r requirements.txt
```

---

## 12. 可扩展方向

1. **更多知识库类型**（地方规范、行业标准）
2. **向量数据库升级**（FAISS → Milvus/PGVector）
3. **多模型协作**（Planner/Executor/Checker）
4. **更强网页搜索**（多线程抓取 + 反爬策略）
5. **文书模板库扩展**（起诉状、律师函、仲裁申请等）

---

## 13. 附录：动态骨架 Agent 价值总结

- **核心优势**：
  - 每个问题流程不同，非模板化
  - 动作组合可扩展
  - 能根据检索质量实时调整

- **实际效果**：
  - 提升回答专业度
  - 提升用户信任
  - 输出更可执行

---

以上即为 LAW MASTER V1.0 的开发文档，覆盖动态骨架 Agent、Action 体系、知识库构建、检索系统与 UI 工作流。
