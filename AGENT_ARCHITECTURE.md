# LAW MASTER v1.0 — Agent 架构说明

> 适用范围：主工程（`Law-Master-main/`）  
> 目标：说明端到端的 Agent 规划、检索、回答、文书生成与 UI 交互流程  
> 版本日期：2026-02-09

---

## 1. 总览

LAW MASTER v1.0 采用 **“规划型智能体 + 多工具执行 + RAG 合规输出”** 的架构：

1. **用户输入**（文本/语音/文件/图片）
2. **澄清与规划**（DeepSeek Reasoner）
3. **检索执行**（法条库 + 案例库 + 可选网页搜索）
4. **综合回答**（DeepSeek Chat）
5. **可选文书生成**（模板 + RAG 依据 + PDF 输出）
6. **思维导图生成**（结构化回放）
7. **UI 渐进式流式输出 + 进度/状态同步**

---

## 2. 核心模块

### 2.1 前端 UI（FastAPI 静态页面）
功能：
- 多轮对话（流式输出）
- 文件上传（文本/图片）
- 语音输入（Whisper 可选）
- OCR（浏览器端 `Tesseract.js`）
- “探索过程（实时）”面板（状态 + 进度条 + 过程日志）
- “检索详情”折叠（法条/案例双通道）
- 网页搜索结果折叠
- 文书预览 + PDF 下载
- 思维导图（SVG，可拖拽/缩放）

### 2.2 规划器（DeepSeek Reasoner）
职责：
- 判断是否需要澄清问题
- 产出探索计划与步骤
- 决定是否需要网页搜索
- 指定行动类型：  
  - `direct_answer`（直接回答）  
  - `rag`（仅知识库）  
  - `web_search`（网页搜索）  
  - `generate_document`（文书生成）

输出要点：
- `goal_analysis`（目标分析）
- `plan` / `step_details` / `subtasks`
- `search_needed` + `search_queries`
- `clarifying_questions`
- `document_type`

### 2.3 澄清问题机制
两层机制：
1. **快速澄清**：在进入完整规划前先快速询问关键缺口
2. **主规划澄清**：Reasoner 生成更像律师式的问题

若已在会话中回答过，会写入“稀疏记忆”，下一轮避免重复问。

### 2.4 RAG 检索
双库结构：
- **法条库**：`corpus_enriched_fast.jsonl`
- **案例库**：`case_kb.jsonl`

检索方式：
- 关键词检索 + TF-IDF 语义检索
- 可调权重：`keyword_weight` / `vector_weight`
- 结果合并用于：
  - 最终回答（法条 + 案例引用）
  - 文书生成
  - 思维导图摘要

### 2.5 网页搜索
触发方式：
- Reasoner 判定需要
- 或用户强制启用（UI“网页搜索”开关）

流程：
1. 生成关键词
2. 搜索并抓取网页文本
3. 评估是否足够
4. 不足则改写关键词重复搜索

输出：
- `search_results`（标题 / URL / 摘要 / 正文片段）
- 进入最终答案与思维导图

### 2.6 最终回答生成（DeepSeek Chat）
输入：
- 法条上下文
- 案例上下文
- 网页搜索摘要（若有）
- 用户补充材料
- 会话稀疏记忆

输出结构：
1. 结论  
2. 法条依据（条文解释 + 要件对应）  
3. 分析（事实 → 要件 → 结论）  
4. 建议  
5. 风险提示

### 2.7 文书生成
触发：
- 规划结果 `action=generate_document`
- 或用户明确要求

特点：
- 固定模板骨架 + RAG 法条/案例引用
- 明确“事实 → 法条要件 → 对方行为构成”的对应关系
- 生成 PDF，支持图片证据插入

输出：
- `documents[]`（标题、正文、图片 ID）
- 生成 PDF 下载链接

### 2.8 思维导图
生成时机：
- 最终回答后

内容来源：
- 目标分析
- 探索计划
- 法条/案例/网页摘要
- 用户事实陈述（必须包含）

特点：
- SVG 可拖拽/缩放
- 节点点击弹窗查看详细摘要

---

## 3. 数据与存储

### 3.1 知识库文件
- 法条库：`corpus_enriched_fast.jsonl`
- 案例库：`case_kb.jsonl`
- 扩展知识库：运行中可追加（不覆盖原库）

### 3.2 稀疏记忆
目的：  
在长对话中保存关键事实、用户意图、已确认信息，减少重复澄清。

特点：
- 只存“关键信息”
- 与会话 `session_id` 绑定
- 在后续回答和文书生成中作为“历史要点”输入

---

## 4. API 与消息流

### 4.1 主要 API
- `POST /api/agent_stream`  
  主 Agent 流式输出（规划、检索、回答、导图）

- `POST /api/chat_stream`  
  简化 RAG 流式输出（无规划）

- `POST /api/parse_file`  
  文件解析与 OCR

- `POST /api/generate_document`  
  文书生成与 PDF 输出

### 4.2 Streaming 消息类型
- `status`：阶段状态（思考/搜索/总结）  
- `trace`：过程日志（搜索关键词/结果数）  
- `progress`：进度条百分比  
- `delta`：回答内容流式输出  
- `meta`：汇总结果（检索结果、导图、文档链接）

---

## 5. UI 进度分配（示例）

默认进度拆分：
- 10%：规划完成  
- 30%：知识库检索完成  
- 35%~70%：网页检索与抓取（每页均匀推进）  
- 70%~90%：最终回答生成  
- 90%~100%：思维导图生成

---

## 6. 安全与合规提示

系统会在最终回答中提示：
> “仅供参考，不构成正式法律意见”

文书预览界面提示：
- 请补充个人信息
- 产品会保护用户信息安全

---

## 7. 可扩展方向

1. **更多知识库类型**  
   - 地方法规、判决数据库、行业规范等

2. **更强检索**  
   - 关键词分层权重  
   - 向量检索替换为向量数据库

3. **多模型协作**  
   - Planner / Executor / Checker 分离

4. **思维导图增强**  
   - 动态节点高度  
   - 自动布局算法  
   - 导出 PNG/PDF

